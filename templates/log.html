{% extends "base.html" %}
{% block content %}

<div class="container mt-2"> 
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg border-0 bg-dark text-white">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center bg-dark py-2">
                    <h5 class="mb-0 text-info fw-bold" style="font-size: 1.1rem;">
                        <i class="bi bi-terminal-fill me-2"></i>시스템 실시간 로그 <small class="text-muted" id="status-text">(연결 중...)</small>
                    </h5>
                    <div>
                        <span class="badge bg-danger pulse-red me-2">LIVE</span>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleAutoScroll()" id="scroll-btn">
                            <i class="bi bi-lock-fill"></i> 자동 스크롤 ON
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div id="log-container" class="log-viewer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .log-viewer {
        background-color: #000;
        color: #e0e0e0;
        font-family: 'Consolas', 'Monaco', monospace;
        padding: 15px;
        height: 700px;
        overflow-y: auto;
        font-size: 0.85rem;
        line-height: 1.5;
    }
    .log-line {
        border-bottom: 1px solid #1a1a1a;
        padding: 4px 0;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .log-info { color: #51cf66; }
    .log-error { color: #ff6b6b; font-weight: bold; }
    .log-warn { color: #fcc419; }
</style>

<script>
    let autoScroll = true;
    let lastLogContent = "";

    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const btn = document.getElementById('scroll-btn');
        btn.innerHTML = autoScroll ? '<i class="bi bi-lock-fill"></i> 자동 스크롤 ON' : '<i class="bi bi-unlock"></i> 자동 스크롤 OFF';
        btn.className = autoScroll ? 'btn btn-sm btn-outline-light' : 'btn btn-sm btn-secondary';
    }

    async function fetchLogs() {
        try {
            // main_page.py의 bp.route 경로인 /get_raw_logs 호출
            const response = await fetch('/get_raw_logs'); 
            const data = await response.text();
            
            if (data !== lastLogContent) {
                const container = document.getElementById('log-container');
                container.innerHTML = formatLogs(data);
                lastLogContent = data;
                
                if (autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
                document.getElementById('status-text').innerText = "(업데이트: " + new Date().toLocaleTimeString() + ")";
            }
        } catch (e) {
            document.getElementById('status-text').innerText = "(연결 오류)";
        }
    }

    function formatLogs(text) {
        return text.split('\n').reverse().map(line => { // 최신 로그를 위해 뒤집어서 처리 가능 (취향껏)
            const cleanLine = line.trim();
            if (!cleanLine) return '';

            // [신의 필터] 접속 기록 로그는 화면에서 완전히 제외합니다.
            if (cleanLine.includes('/get_raw_logs') || cleanLine.includes('/log')) {
                return ''; 
            }

            let className = '';
            if (cleanLine.includes('ERROR')) className = 'log-error';
            else if (cleanLine.includes('INFO')) className = 'log-info';
            else if (cleanLine.includes('WARNING')) className = 'log-warn';
            
            return `<div class="log-line ${className}">${cleanLine}</div>`;
        }).reverse().join(''); // 다시 원상복구하여 출력
    }

    setInterval(fetchLogs, 2000);
    fetchLogs();
</script>

{% endblock %}